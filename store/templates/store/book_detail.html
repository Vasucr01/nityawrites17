{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ book.title }} - Nityawrites{% endblock %}

{% block seo_title %}{{ book.title }} by {{ book.author }} | Nityawrites{% endblock %}
{% block seo_description %}{{ book.description|truncatewords:25 }}{% endblock %}

{% block og_title %}{{ book.title }} - Buy Online at Nityawrites{% endblock %}
{% block og_description %}{{ book.description|truncatewords:20 }}{% endblock %}
{% if book.image %}
  {% block og_image %}{{ book.image.url }}{% endblock %}
{% endif %}

{% block extra_css %}
<!-- Structured Data for Google -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Book",
  "name": "{{ book.title }}",
  "author": {
    "@type": "Person",
    "name": "{{ book.author }}"
  },
  "description": "{{ book.description|truncatewords:50|escapejs }}",
  "image": "{{ request.scheme }}://{{ request.get_host }}{{ book.image.url }}",
  "offers": {
    "@type": "Offer",
    "price": "{{ book.price }}",
    "priceCurrency": "INR",
    "availability": "https://schema.org/{% if book.stock > 0 %}InStock{% else %}OutOfStock{% endif %}"
  }
}
</script>
{% endblock %}

{% block content %}
<!-- HERO -->
<section class="hero">
  <div class="hero-content">
    <h1>{{ book.title }}</h1>
    <p class="tagline">by {{ book.author }}</p>
    <p class="price">‚Çπ{{ book.price }}</p>
    {% if book.stock > 0 %}
      <a href="{% url 'cart_add' book.pk %}" class="btn">Add to Cart</a>
    {% else %}
      <p style="color: red; font-weight: bold;">Out of Stock</p>
    {% endif %}
  </div>
</section>

<!-- ABOUT -->
<section class="about">
  <h2>About The Book</h2>
  
  <div class="book-detail-grid">
    <div class="book-image">
      {% if book.image %}
        <img src="{{ book.image.url }}" alt="{{ book.title }}" style="width: 100%; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
      {% else %}
        <div style="width: 100%; height: 400px; background: linear-gradient(135deg, #f5f1ed, #e8dfd6); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #7a5c4d; font-size: 24px;">
          üìö {{ book.title }}
        </div>
      {% endif %}
    </div>
    
    <div class="book-info">
      <p style="line-height: 1.8; color: #333;">{{ book.description }}</p>
      <div style="margin-top: 20px;">
        <p><strong>Author:</strong> {{ book.author }}</p>
        <p><strong>Price:</strong> ‚Çπ{{ book.price }}</p>
        <p><strong>Stock:</strong> {{ book.stock }} available</p>
      </div>
      
      <div class="action-buttons" style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
        {% if book.stock > 0 %}
          <a href="{% url 'cart_add' book.pk %}" class="btn">Add to Cart</a>
        {% endif %}
        <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back to Books</a>
      </div>

      <!-- Social Sharing -->
      <div class="social-sharing" style="margin-top: 40px; padding-top: 25px; border-top: 1px solid #eee;">
        <p style="font-weight: 600; color: var(--coffee-brown); margin-bottom: 15px;">Share this book:</p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <a href="https://wa.me/?text={{ book.title|urlencode }}%20-%20Available%20at%20Nityawrites:%20{{ request.build_absolute_uri|urlencode }}" 
             target="_blank" class="share-btn whatsapp" style="background: #25D366;">
            <span>WhatsApp</span>
          </a>
          <a href="https://twitter.com/intent/tweet?text=Check%20out%20{{ book.title|urlencode }}%20at%20Nityawrites&url={{ request.build_absolute_uri|urlencode }}" 
             target="_blank" class="share-btn twitter" style="background: #1DA1F2;">
            <span>Twitter</span>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" 
             target="_blank" class="share-btn facebook" style="background: #4267B2;">
            <span>Facebook</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="reviews-section" style="margin-top: 80px; max-width: 1000px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 30px;">
      <h2 style="margin: 0; font-size: 2rem;">Reader Reviews</h2>
      <div style="font-size: 1.1rem; color: var(--mocha);">
        {% if reviews %}
          <span style="color: #FFD700;">‚òÖ</span> {{ avg_rating|floatformat:1 }} / 5.0 ({{ reviews.count }} reviews)
        {% else %}
          No reviews yet
        {% endif %}
      </div>
    </div>

    <div class="reviews-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 60px;">
      {% for review in reviews %}
        <div class="review-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #f0ece8;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong style="color: var(--coffee_brown);">{{ review.name }}</strong>
            <div style="color: #FFD700;">
              {% for i in "12345" %}
                {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
              {% endfor %}
            </div>
          </div>
          <p style="font-size: 0.95rem; color: #555; font-style: italic; line-height: 1.6;">"{{ review.comment }}"</p>
          <small style="color: #999; display: block; margin-top: 15px;">{{ review.created_at|date:"M d, Y" }}</small>
        </div>
      {% empty %}
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #faf8f5; border-radius: 15px; color: #888;">
          <p>Be the first to share your thoughts on this book!</p>
        </div>
      {% endfor %}
    </div>

    <!-- Review Form -->
    <div class="review-form-container" style="background: #fdfaf8; padding: 40px; border-radius: 20px; border: 2px dashed var(--warm-tan);">
      <h3 style="margin-top: 0; margin-bottom: 25px;">Leave a Review</h3>
      <form action="{% url 'submit_review' book.pk %}" method="POST" style="background: transparent; box-shadow: none; padding: 0; max-width: 100%;">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Your Name</label>
            <input type="text" name="name" required placeholder="John Doe" style="margin-bottom: 0;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Rating</label>
            <select name="rating" required style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--warm-tan); background: white;">
              <option value="5">5 Stars - Amazing</option>
              <option value="4">4 Stars - Very Good</option>
              <option value="3">3 Stars - Good</option>
              <option value="2">2 Stars - Okay</option>
              <option value="1">1 Star - Poor</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Your Thoughts</label>
          <textarea name="comment" required rows="4" placeholder="What did you love about this story?" style="margin-bottom: 0;"></textarea>
        </div>
        <button type="submit" class="btn" style="width: 100%; font-weight: 600;">Post Review ‚ú¶</button>
      </form>
    </div>
  </div>
</section>
{% endblock %}
