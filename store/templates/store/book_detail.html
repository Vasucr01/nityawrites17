{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ book.title }} - Nityawrites{% endblock %}

{% block seo_title %}{{ book.title }} by {{ book.author }} | Nityawrites{% endblock %}
{% block seo_description %}{{ book.description|truncatewords:25 }}{% endblock %}

{% block og_title %}{{ book.title }} - Buy Online at Nityawrites{% endblock %}
{% block og_description %}{{ book.description|truncatewords:20 }}{% endblock %}
{% if book.image %}
  {% block og_image %}{{ book.image.url }}{% endblock %}
{% endif %}

{% block extra_css %}
<!-- Structured Data for Google -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Book",
  "name": "{{ book.title }}",
  "author": {
    "@type": "Person",
    "name": "{{ book.author }}"
  },
  "description": "{{ book.description|truncatewords:50|escapejs }}",
  "image": "{{ request.scheme }}://{{ request.get_host }}{{ book.image.url }}",
  "offers": {
    "@type": "Offer",
    "price": "{{ book.price }}",
    "priceCurrency": "INR",
    "availability": "https://schema.org/{% if book.stock > 0 %}InStock{% else %}OutOfStock{% endif %}"
  }
}
</script>
{% endblock %}

{% block content %}
<!-- HERO -->
<section class="hero">
  <div class="hero-content">
    <h1>{{ book.title }}</h1>
    <p class="tagline">by {{ book.author }}</p>
    <p class="price">‚Çπ{{ book.price }}</p>
    {% if book.stock > 0 %}
      <a href="{% url 'cart_add' book.pk %}" class="btn">Add to Cart</a>
    {% else %}
      <p style="color: red; font-weight: bold;">Out of Stock</p>
    {% endif %}
  </div>
</section>

<!-- ABOUT -->
<section class="about">
  <h2>About The Book</h2>
  
  <div class="book-detail-grid">
    <div class="book-image">
      {% if book.image %}
        <div class="image-wrapper">
          <img src="{{ book.image.url }}" alt="{{ book.title }}">
        </div>
      {% else %}
        <div class="image-placeholder">
          üìö {{ book.title }}
        </div>
      {% endif %}
    </div>
    
    <div class="book-info">
      <p style="line-height: 1.8; color: #333;">{{ book.description }}</p>
      <div style="margin-top: 20px;">
        <p><strong>Author:</strong> {{ book.author }}</p>
        <p><strong>Price:</strong> ‚Çπ{{ book.price }}</p>
        <p><strong>Stock:</strong> {{ book.stock }} available</p>
      </div>
      
      <div class="action-buttons" style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
        {% if book.stock > 0 %}
          <a href="{% url 'cart_add' book.pk %}" class="btn">Add to Cart</a>
        {% endif %}
        <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back to Books</a>
      </div>

      <!-- Social Sharing -->
      <div class="social-sharing" style="margin-top: 40px; padding-top: 25px; border-top: 1px solid #eee;">
        <p style="font-weight: 600; color: var(--coffee-brown); margin-bottom: 15px;">Share via:</p>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <a href="https://wa.me/?text={{ book.title|urlencode }}%20-%20Available%20at%20Nityawrites:%20{{ request.build_absolute_uri|urlencode }}" 
             target="_blank" class="share-icon whatsapp" title="Share on WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </a>
          <button onclick="shareOnSocial()" class="share-icon instagram" title="Share link">
            <i class="fab fa-instagram"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="reviews-section" style="margin-top: 80px; max-width: 1000px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 30px;">
      <h2 style="margin: 0; font-size: 2rem;">Reader Reviews</h2>
      <div style="font-size: 1.1rem; color: var(--mocha);">
        {% if reviews %}
          {{ reviews.count }} Reviews
        {% else %}
          No reviews yet
        {% endif %}
      </div>
    </div>

    <div class="reviews-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 60px;">
      {% for review in reviews %}
        <div class="review-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #f0ece8;">
          <div style="margin-bottom: 10px;">
            <strong style="color: var(--coffee-brown);">{{ review.name }}</strong>
          </div>
          <p style="font-size: 0.95rem; color: #555; font-style: italic; line-height: 1.6;">"{{ review.comment }}"</p>
          <small style="color: #999; display: block; margin-top: 15px;">{{ review.created_at|date:"M d, Y" }}</small>
        </div>
      {% empty %}
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #faf8f5; border-radius: 15px; color: #888;">
          <p>Be the first to share your thoughts on this book!</p>
        </div>
      {% endfor %}
    </div>

    <!-- Review Form -->
    <div class="review-form-container" style="background: #fdfaf8; padding: 40px; border-radius: 20px; border: 2px dashed var(--warm-tan);">
      <h3 style="margin-top: 0; margin-bottom: 25px;">Leave a Review</h3>
      <form action="{% url 'submit_review' book.pk %}" method="POST" style="background: transparent; box-shadow: none; padding: 0; max-width: 100%;">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Your Name</label>
            <input type="text" name="name" required placeholder="John Doe" style="margin-bottom: 0; width: 100%; padding: 12px; border: 2px solid var(--warm-tan); border-radius: 10px;">
          </div>
        </div>
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Your Thoughts</label>
          <textarea name="comment" required rows="4" placeholder="What did you love about this story?"></textarea>
        </div>
        <button type="submit" class="btn" style="width: 100%; font-weight: 600;">Post Review ‚ú¶</button>
      </form>
    </div>
  </div>
</section>

<script>
function shareOnSocial() {
  const shareData = {
    title: '{{ book.title }}',
    text: 'Check out this amazing book at Nityawrites!',
    url: window.location.href,
  };

  if (navigator.share) {
    navigator.share(shareData).catch((err) => console.log('Error sharing', err));
  } else {
    // Fallback: Copy to clipboard
    navigator.clipboard.writeText(window.location.href);
    alert('Link copied to clipboard! You can now share it on Instagram.');
  }
}
</script>
{% endblock %}
